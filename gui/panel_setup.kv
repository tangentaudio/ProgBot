#:kivy 2.0

# Panel Setup Dialog Layout
# This file defines the PanelSetupPopup widget for panel configuration:
# - Parameters tab: Grid dimensions (columns, rows, width, height)
# - Origins tab: Board origin (X, Y), probe offset, Z calibration, jogging
# - Vision tab: Camera preview, QR code detection, QR offset calibration

<PanelSetupPopup@Popup>:
    id: panel_setup_popup
    title: ''
    size_hint: 1, 1
    auto_dismiss: False
    separator_height: 0
    
    BoxLayout:
        orientation: 'vertical'
        spacing: 2
        padding: 2
        
        # Custom title bar
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: 54
            padding: [10, 7]
            spacing: 10
            canvas.before:
                Color:
                    rgba: 0.15, 0.15, 0.2, 1
                Rectangle:
                    pos: self.pos
                    size: self.size
            
            Label:
                text: 'Panel Setup'
                size_hint_x: None
                width: 130
                font_size: '18sp'
                bold: True
                halign: 'left'
                valign: 'center'
                text_size: self.size
            
            Label:
                id: ps_panel_filename
                text: ''
                font_size: '14sp'
                color: 0.7, 0.8, 0.9, 1
                halign: 'left'
                valign: 'center'
                text_size: self.size
            
            Button:
                id: ps_save_btn
                text: 'Save'
                size_hint_x: None
                size_hint_y: None
                width: 70
                height: 40
                halign: 'center'
                valign: 'center'
                text_size: self.size
                background_color: 0.2, 0.5, 0.3, 1
                disabled: True
                on_press: app.ps_save_panel()
            
            Button:
                text: 'Close'
                size_hint_x: None
                size_hint_y: None
                width: 70
                height: 40
                halign: 'center'
                valign: 'center'
                text_size: self.size
                on_press: app.ps_close()
        
        TabbedPanel:
            id: ps_tabs
            do_default_tab: False
            tab_width: 120
            tab_height: 40
            
            TabbedPanelItem:
                id: parameters_tab
                text: 'Parameters'
                
                BoxLayout:
                    orientation: 'vertical'
                    spacing: 10
                    padding: 20
                    
                    # Grid Parameters section
                    Label:
                        text: 'Grid Parameters'
                        size_hint_y: None
                        height: 30
                        font_size: '16sp'
                        bold: True
                        halign: 'left'
                        valign: 'center'
                        text_size: self.size
                    
                    GridLayout:
                        cols: 2
                        spacing: 10
                        size_hint_y: None
                        height: 240
                        
                        Label:
                            text: 'Board Columns:'
                            size_hint_y: None
                            height: 40
                            font_size: '14sp'
                            halign: 'right'
                            valign: 'center'
                            text_size: self.size
                        
                        Spinner:
                            id: ps_board_cols_spinner
                            text: '2'
                            values: ['1', '2', '3', '4', '5', '6']
                            size_hint_y: None
                            height: 40
                            size_hint_x: 0.5
                            on_text: app.ps_on_board_cols_change(self.text)
                        
                        Label:
                            text: 'Board Rows:'
                            size_hint_y: None
                            height: 40
                            font_size: '14sp'
                            halign: 'right'
                            valign: 'center'
                            text_size: self.size
                        
                        Spinner:
                            id: ps_board_rows_spinner
                            text: '5'
                            values: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10']
                            size_hint_y: None
                            height: 40
                            size_hint_x: 0.5
                            on_text: app.ps_on_board_rows_change(self.text)
                        
                        Label:
                            text: 'Column Width (mm):'
                            size_hint_y: None
                            height: 40
                            font_size: '14sp'
                            halign: 'right'
                            valign: 'center'
                            text_size: self.size
                        
                        TextInput:
                            id: ps_col_width_input
                            text: '48.0'
                            size_hint_y: None
                            height: 40
                            size_hint_x: 0.5
                            multiline: False
                            input_filter: 'float'
                            on_focus: app.set_keyboard_layout('numpad') if self.focus else app.ps_on_col_width_change(self.text)
                            on_text_validate: app.ps_on_col_width_change(self.text)
                        
                        Label:
                            text: 'Row Height (mm):'
                            size_hint_y: None
                            height: 40
                            font_size: '14sp'
                            halign: 'right'
                            valign: 'center'
                            text_size: self.size
                        
                        TextInput:
                            id: ps_row_height_input
                            text: '29.0'
                            size_hint_y: None
                            height: 40
                            size_hint_x: 0.5
                            multiline: False
                            input_filter: 'float'
                            on_focus: app.set_keyboard_layout('numpad') if self.focus else app.ps_on_row_height_change(self.text)
                            on_text_validate: app.ps_on_row_height_change(self.text)
                    
                    Widget:
                        size_hint_y: 1
            
            TabbedPanelItem:
                id: origins_tab
                text: 'Origins'
                
                BoxLayout:
                    orientation: 'vertical'
                    spacing: 4
                    padding: 4
                    
                    # Row 1: Main controls - Z buttons, Z steps, XY steps, XY pad
                    BoxLayout:
                        orientation: 'horizontal'
                        size_hint_y: None
                        height: 200
                        spacing: 4
                        
                        # Z Buttons (vertical)
                        BoxLayout:
                            orientation: 'vertical'
                            size_hint_x: 0.25
                            spacing: 4
                            
                            Button:
                                id: ps_z_up
                                text: 'Z+'
                                font_size: '20sp'
                                on_press: app.ps_jog('z', 1)
                            
                            Button:
                                id: ps_z_down
                                text: 'Z-'
                                font_size: '20sp'
                                on_press: app.ps_jog('z', -1)
                        
                        # Z Step selector
                        BoxLayout:
                            orientation: 'vertical'
                            size_hint_x: 0.17
                            spacing: 2
                            
                            ToggleButton:
                                id: ps_z_step_1
                                text: '1'
                                group: 'z_step'
                                font_size: '13sp'
                                state: 'down'
                                on_state: app.ps_set_z_step(1) if self.state == 'down' else None
                            
                            ToggleButton:
                                id: ps_z_step_05
                                text: '.5'
                                group: 'z_step'
                                font_size: '13sp'
                                on_state: app.ps_set_z_step(0.5) if self.state == 'down' else None
                            
                            ToggleButton:
                                id: ps_z_step_02
                                text: '.2'
                                group: 'z_step'
                                font_size: '13sp'
                                on_state: app.ps_set_z_step(0.2) if self.state == 'down' else None
                            
                            ToggleButton:
                                id: ps_z_step_01
                                text: '.1'
                                group: 'z_step'
                                font_size: '13sp'
                                on_state: app.ps_set_z_step(0.1) if self.state == 'down' else None
                            
                            Widget:
                        
                        # Vertical separator
                        Widget:
                            size_hint_x: 0.03
                            canvas:
                                Color:
                                    rgba: 0.4, 0.4, 0.4, 1
                                Rectangle:
                                    pos: self.center_x - 1, self.y + 10
                                    size: 2, self.height - 20
                        
                        # XY Step selector
                        BoxLayout:
                            orientation: 'vertical'
                            size_hint_x: None
                            width: 50
                            spacing: 2
                            
                            ToggleButton:
                                id: ps_xy_step_20
                                text: '20'
                                group: 'xy_step'
                                font_size: '13sp'
                                on_state: app.ps_set_xy_step(20) if self.state == 'down' else None
                            
                            ToggleButton:
                                id: ps_xy_step_10
                                text: '10'
                                group: 'xy_step'
                                font_size: '13sp'
                                on_state: app.ps_set_xy_step(10) if self.state == 'down' else None
                            
                            ToggleButton:
                                id: ps_xy_step_5
                                text: '5'
                                group: 'xy_step'
                                font_size: '13sp'
                                state: 'down'
                                on_state: app.ps_set_xy_step(5) if self.state == 'down' else None
                            
                            ToggleButton:
                                id: ps_xy_step_1
                                text: '1'
                                group: 'xy_step'
                                font_size: '13sp'
                                on_state: app.ps_set_xy_step(1) if self.state == 'down' else None
                            
                            ToggleButton:
                                id: ps_xy_step_05
                                text: '.5'
                                group: 'xy_step'
                                font_size: '13sp'
                                on_state: app.ps_set_xy_step(0.5) if self.state == 'down' else None
                            
                            ToggleButton:
                                id: ps_xy_step_02
                                text: '.2'
                                group: 'xy_step'
                                font_size: '13sp'
                                on_state: app.ps_set_xy_step(0.2) if self.state == 'down' else None
                            
                            ToggleButton:
                                id: ps_xy_step_01
                                text: '.1'
                                group: 'xy_step'
                                font_size: '13sp'
                                on_state: app.ps_set_xy_step(0.1) if self.state == 'down' else None
                        
                        # XY Arrow Pad (3x3 grid)
                        GridLayout:
                            cols: 3
                            rows: 3
                            size_hint_x: None
                            width: 180
                            spacing: 3
                            
                            Widget:
                            Button:
                                id: ps_y_plus
                                text: 'Y+'
                                font_size: '18sp'
                                on_press: app.ps_jog('y', 1)
                            Widget:
                            
                            Button:
                                id: ps_x_minus
                                text: 'X-'
                                font_size: '18sp'
                                on_press: app.ps_jog('x', -1)
                            Widget:
                            Button:
                                id: ps_x_plus
                                text: 'X+'
                                font_size: '18sp'
                                on_press: app.ps_jog('x', 1)
                            
                            Widget:
                            Button:
                                id: ps_y_minus
                                text: 'Y-'
                                font_size: '18sp'
                                on_press: app.ps_jog('y', -1)
                            Widget:
                    
                    # Spacer between jog controls and button/info area
                    Widget:
                        size_hint_y: 0.03
                    
                    # Combined buttons and info area
                    BoxLayout:
                        orientation: 'horizontal'
                        size_hint_y: 0.24
                        spacing: 10
                        
                        # Left side: 2x4 button grid
                        GridLayout:
                            cols: 4
                            rows: 2
                            size_hint_x: 0.5
                            spacing: 4
                            
                            # Row 1: XY buttons
                            Button:
                                id: ps_home_btn
                                text: 'Go Home'
                                font_size: '13sp'
                                background_color: 0.5, 0.5, 0.3, 1
                                on_press: app.ps_home()
                            
                            Button:
                                id: ps_goto_origin_btn
                                text: 'Go Origin'
                                font_size: '13sp'
                                background_color: 0.3, 0.5, 0.6, 1
                                on_press: app.ps_goto_origin()
                            
                            Widget:
                                # Spacer for alignment
                            
                            Button:
                                id: ps_set_origin_btn
                                text: 'Set Origin'
                                font_size: '13sp'
                                background_color: 0.2, 0.6, 0.3, 1
                                on_press: app.ps_set_board_origin()
                            
                            # Row 2: Z buttons
                            Button:
                                id: ps_safe_z_btn
                                text: 'Go Safe Z'
                                font_size: '13sp'
                                background_color: 0.3, 0.5, 0.7, 1
                                on_press: app.ps_safe_z()
                            
                            Button:
                                id: ps_probe_btn
                                text: 'Probe'
                                font_size: '13sp'
                                background_color: 0.5, 0.3, 0.7, 1
                                on_press: app.ps_do_probe()
                            
                            Button:
                                id: ps_goto_offset_btn
                                text: 'Go Ofs'
                                font_size: '13sp'
                                background_color: 0.4, 0.5, 0.5, 1
                                disabled: True
                                on_press: app.ps_goto_offset()
                            
                            Button:
                                id: ps_set_probe_offset_btn
                                text: 'Set Z Ofs'
                                font_size: '13sp'
                                background_color: 0.6, 0.4, 0.2, 1
                                disabled: True
                                on_press: app.ps_capture_probe_offset()
                        
                        # Right side: 2x2 info/input grid
                        GridLayout:
                            cols: 2
                            rows: 2
                            size_hint_x: 0.5
                            spacing: 4
                            
                            # Row 1, Col 1: Origin X display + input
                            BoxLayout:
                                orientation: 'horizontal'
                                spacing: 4
                                Label:
                                    id: ps_origin_x_label
                                    text: 'Origin X: ---'
                                    font_size: '13sp'
                                    halign: 'right'
                                    valign: 'center'
                                    text_size: self.size
                                TextInput:
                                    id: ps_board_x_input
                                    text: '110.2'
                                    size_hint_x: 0.4
                                    multiline: False
                                    input_filter: 'float'
                                    font_size: '12sp'
                                    on_focus: app.set_keyboard_layout('numpad') if self.focus else app.ps_on_board_x_change(self.text)
                                    on_text_validate: app.ps_on_board_x_change(self.text)
                            
                            # Row 1, Col 2: Origin Y display + input
                            BoxLayout:
                                orientation: 'horizontal'
                                spacing: 4
                                Label:
                                    id: ps_origin_y_label
                                    text: 'Origin Y: ---'
                                    font_size: '13sp'
                                    halign: 'right'
                                    valign: 'center'
                                    text_size: self.size
                                TextInput:
                                    id: ps_board_y_input
                                    text: '121.0'
                                    size_hint_x: 0.4
                                    multiline: False
                                    input_filter: 'float'
                                    font_size: '12sp'
                                    on_focus: app.set_keyboard_layout('numpad') if self.focus else app.ps_on_board_y_change(self.text)
                                    on_text_validate: app.ps_on_board_y_change(self.text)
                            
                            # Row 2, Col 1: Z Offset display + input
                            BoxLayout:
                                orientation: 'horizontal'
                                spacing: 4
                                Label:
                                    id: ps_probe_offset_label
                                    text: 'Z Offset: ---'
                                    font_size: '13sp'
                                    halign: 'right'
                                    valign: 'center'
                                    text_size: self.size
                                TextInput:
                                    id: ps_probe_plane_input
                                    text: '4.0'
                                    size_hint_x: 0.4
                                    multiline: False
                                    input_filter: 'float'
                                    font_size: '12sp'
                                    on_focus: app.set_keyboard_layout('numpad') if self.focus else app.ps_on_probe_plane_change(self.text)
                                    on_text_validate: app.ps_on_probe_plane_change(self.text)
                            
                            # Row 2, Col 2: Empty spacer
                            Widget:
                    
                    # Bottom row: Position display + Probe status
                    BoxLayout:
                        orientation: 'horizontal'
                        size_hint_y: 0.09
                        spacing: 6
                        
                        Label:
                            id: ps_pos_x
                            text: 'X: ---'
                            size_hint_x: 0.2
                            font_size: '15sp'
                            halign: 'center'
                            valign: 'center'
                            text_size: self.size
                            bold: True
                        
                        Label:
                            id: ps_pos_y
                            text: 'Y: ---'
                            size_hint_x: 0.2
                            font_size: '15sp'
                            halign: 'center'
                            valign: 'center'
                            text_size: self.size
                            bold: True
                        
                        Label:
                            id: ps_pos_z
                            text: 'Z: ---'
                            size_hint_x: 0.2
                            font_size: '15sp'
                            halign: 'center'
                            valign: 'center'
                            text_size: self.size
                            bold: True
                        
                        Label:
                            id: ps_probe_result
                            text: 'Probe: ---'
                            size_hint_x: 0.4
                            font_size: '14sp'
                            halign: 'center'
                            valign: 'center'
                            text_size: self.size
            
            EnableableTabbedPanelItem:
                id: vision_tab
                phase_name: 'Vision'
                settings_key: 'vision_enabled'
                phase_enabled: True if app.panel_settings and app.panel_settings.get('vision_enabled', True) else False
                on_state: app.ps_vision_tab_changed(self.state)
                
                BoxLayout:
                    orientation: 'horizontal'
                    spacing: 4
                    padding: 4
                    
                    # Left side: Camera preview and status
                    BoxLayout:
                        orientation: 'vertical'
                        size_hint_x: 0.45
                        spacing: 4
                        
                        # Left side content (disabled when vision is off)
                        BoxLayout:
                            id: vision_left_content
                            orientation: 'vertical'
                            spacing: 4
                            disabled: not vision_tab.phase_enabled
                            opacity: 1.0 if vision_tab.phase_enabled else 0.4
                            
                            # Camera preview area
                            BoxLayout:
                                orientation: 'vertical'
                                
                                Label:
                                    id: vision_status_label
                                    text: 'Camera Preview'
                                    size_hint_y: None
                                    height: 30
                                    font_size: '14sp'
                                    halign: 'center'
                                    color: 0.5, 0.5, 0.5, 1
                                
                                Image:
                                    id: vision_preview_image
                                    size_hint: 1, 1
                                    allow_stretch: True
                                    keep_ratio: True
                                    color: 0, 0, 0, 1
                            
                            # QR Detection result display (centered)
                            BoxLayout:
                                orientation: 'horizontal'
                                size_hint_y: None
                                height: 35
                                spacing: 4
                                
                                Label:
                                    id: vision_qr_type_label
                                    text: 'No code detected'
                                    size_hint_x: 1.0
                                    font_size: '13sp'
                                    halign: 'center'
                                    valign: 'center'
                                    text_size: self.size
                                    color: 0.5, 0.5, 0.5, 1
                                
                                Label:
                                    id: vision_qr_detected_label
                                    text: ''
                                    size_hint_x: 0
                                    font_size: '16sp'
                                    bold: True
                                    halign: 'left'
                                    valign: 'center'
                                    text_size: self.size
                                    color: 0.5, 0.5, 0.5, 1
                            
                            # QR Offset display and inputs
                            BoxLayout:
                                orientation: 'horizontal'
                                size_hint_y: None
                                height: 30
                                spacing: 4
                                
                                Label:
                                    id: vision_qr_offset_label
                                    text: 'QR Offset:'
                                    size_hint_x: 0.25
                                    font_size: '13sp'
                                    halign: 'right'
                                    valign: 'center'
                                    text_size: self.size
                                
                                Label:
                                    text: 'X:'
                                    size_hint_x: 0.08
                                    font_size: '12sp'
                                    halign: 'right'
                                    valign: 'center'
                                    text_size: self.size
                                
                                TextInput:
                                    id: ps_qr_offset_x_input
                                    text: '0.0'
                                    size_hint_x: 0.22
                                    multiline: False
                                    input_filter: 'float'
                                    font_size: '12sp'
                                    on_focus: app.set_keyboard_layout('numpad') if self.focus else app.ps_on_qr_offset_x_change(self.text)
                                    on_text_validate: app.ps_on_qr_offset_x_change(self.text)
                                
                                Label:
                                    text: 'Y:'
                                    size_hint_x: 0.08
                                    font_size: '12sp'
                                    halign: 'right'
                                    valign: 'center'
                                    text_size: self.size
                                
                                TextInput:
                                    id: ps_qr_offset_y_input
                                    text: '0.0'
                                    size_hint_x: 0.22
                                    multiline: False
                                    input_filter: 'float'
                                    font_size: '12sp'
                                    on_focus: app.set_keyboard_layout('numpad') if self.focus else app.ps_on_qr_offset_y_change(self.text)
                                    on_text_validate: app.ps_on_qr_offset_y_change(self.text)
                                
                                Widget:
                                    size_hint_x: 0.15
                            
                            # Position display
                            BoxLayout:
                                orientation: 'horizontal'
                                size_hint_y: None
                                height: 25
                                spacing: 6
                                
                                Label:
                                    id: vision_pos_x
                                    text: 'X: ---'
                                    font_size: '14sp'
                                    halign: 'center'
                                    valign: 'center'
                                    text_size: self.size
                                    bold: True
                                
                                Label:
                                    id: vision_pos_y
                                    text: 'Y: ---'
                                    font_size: '14sp'
                                    halign: 'center'
                                    valign: 'center'
                                    text_size: self.size
                                    bold: True
                            
                            # Rotation controls
                            BoxLayout:
                                orientation: 'horizontal'
                                size_hint_y: None
                                height: 30
                                spacing: 4
                                
                                Label:
                                    text: 'Rotate:'
                                    size_hint_x: 0.2
                                    font_size: '12sp'
                                    halign: 'right'
                                    valign: 'center'
                                    text_size: self.size
                                
                                ToggleButton:
                                    id: vision_rot_0
                                    text: '0째'
                                    group: 'vision_rotation'
                                    size_hint_x: 0.2
                                    font_size: '12sp'
                                    on_state: app.ps_vision_set_rotation(0) if self.state == 'down' else None
                                
                                ToggleButton:
                                    id: vision_rot_90
                                    text: '90째'
                                    group: 'vision_rotation'
                                    size_hint_x: 0.2
                                    font_size: '12sp'
                                    on_state: app.ps_vision_set_rotation(90) if self.state == 'down' else None
                                
                                ToggleButton:
                                    id: vision_rot_180
                                    text: '180째'
                                    group: 'vision_rotation'
                                    size_hint_x: 0.2
                                    font_size: '12sp'
                                    on_state: app.ps_vision_set_rotation(180) if self.state == 'down' else None
                                
                                ToggleButton:
                                    id: vision_rot_270
                                    text: '270째'
                                    group: 'vision_rotation'
                                    size_hint_x: 0.2
                                    font_size: '12sp'
                                    on_state: app.ps_vision_set_rotation(270) if self.state == 'down' else None
                    
                    # Right side: XY jog controls and action buttons (disabled when vision is off)
                    BoxLayout:
                        id: vision_right_content
                        orientation: 'vertical'
                        size_hint_x: 0.55
                        spacing: 4
                        disabled: not vision_tab.phase_enabled
                        opacity: 1.0 if vision_tab.phase_enabled else 0.4
                        
                        # Board selector and XY Jog controls
                        BoxLayout:
                            orientation: 'horizontal'
                            size_hint_y: None
                            height: 200
                            spacing: 4
                            
                            # Board selector (3x3 grid cross)
                            BoxLayout:
                                orientation: 'vertical'
                                size_hint_x: None
                                width: 100
                                spacing: 2
                                
                                Label:
                                    text: 'Board'
                                    size_hint_y: None
                                    height: 18
                                    font_size: '11sp'
                                    halign: 'center'
                                    color: 0.7, 0.7, 0.7, 1
                                
                                GridLayout:
                                    cols: 3
                                    rows: 3
                                    spacing: 2
                                    
                                    Widget:
                                    Button:
                                        text: 'R+'
                                        font_size: '14sp'
                                        on_press: app.ps_vision_board_change('row', 1)
                                    Widget:
                                    
                                    Button:
                                        text: 'C-'
                                        font_size: '14sp'
                                        on_press: app.ps_vision_board_change('col', -1)
                                    Label:
                                        id: vision_board_pos_label
                                        text: '0,0'
                                        font_size: '14sp'
                                        bold: True
                                        halign: 'center'
                                        valign: 'middle'
                                        text_size: self.size
                                    Button:
                                        text: 'C+'
                                        font_size: '14sp'
                                        on_press: app.ps_vision_board_change('col', 1)
                                    
                                    Widget:
                                    Button:
                                        text: 'R-'
                                        font_size: '14sp'
                                        on_press: app.ps_vision_board_change('row', -1)
                                    Widget:
                            
                            # Spacer to push XY controls to the right
                            Widget:
                            
                            # XY Step selector
                            BoxLayout:
                                orientation: 'vertical'
                                size_hint_x: None
                                width: 50
                                spacing: 2
                                
                                ToggleButton:
                                    id: vision_xy_step_20
                                    text: '20'
                                    group: 'vision_xy_step'
                                    font_size: '13sp'
                                    on_state: app.ps_vision_set_xy_step(20) if self.state == 'down' else None
                                
                                ToggleButton:
                                    id: vision_xy_step_10
                                    text: '10'
                                    group: 'vision_xy_step'
                                    font_size: '13sp'
                                    on_state: app.ps_vision_set_xy_step(10) if self.state == 'down' else None
                                
                                ToggleButton:
                                    id: vision_xy_step_5
                                    text: '5'
                                    group: 'vision_xy_step'
                                    font_size: '13sp'
                                    state: 'down'
                                    on_state: app.ps_vision_set_xy_step(5) if self.state == 'down' else None
                                
                                ToggleButton:
                                    id: vision_xy_step_1
                                    text: '1'
                                    group: 'vision_xy_step'
                                    font_size: '13sp'
                                    on_state: app.ps_vision_set_xy_step(1) if self.state == 'down' else None
                                
                                ToggleButton:
                                    id: vision_xy_step_05
                                    text: '.5'
                                    group: 'vision_xy_step'
                                    font_size: '13sp'
                                    on_state: app.ps_vision_set_xy_step(0.5) if self.state == 'down' else None
                                
                                ToggleButton:
                                    id: vision_xy_step_02
                                    text: '.2'
                                    group: 'vision_xy_step'
                                    font_size: '13sp'
                                    on_state: app.ps_vision_set_xy_step(0.2) if self.state == 'down' else None
                                
                                ToggleButton:
                                    id: vision_xy_step_01
                                    text: '.1'
                                    group: 'vision_xy_step'
                                    font_size: '13sp'
                                    on_state: app.ps_vision_set_xy_step(0.1) if self.state == 'down' else None
                            
                            # XY Arrow Pad (3x3 grid)
                            GridLayout:
                                cols: 3
                                rows: 3
                                size_hint_x: None
                                width: 180
                                spacing: 3
                                
                                Widget:
                                Button:
                                    id: vision_y_plus
                                    text: 'Y+'
                                    font_size: '18sp'
                                    on_press: app.ps_vision_jog('y', 1)
                                Widget:
                                
                                Button:
                                    id: vision_x_minus
                                    text: 'X-'
                                    font_size: '18sp'
                                    on_press: app.ps_vision_jog('x', -1)
                                Widget:
                                Button:
                                    id: vision_x_plus
                                    text: 'X+'
                                    font_size: '18sp'
                                    on_press: app.ps_vision_jog('x', 1)
                                
                                Widget:
                                Button:
                                    id: vision_y_minus
                                    text: 'Y-'
                                    font_size: '18sp'
                                    on_press: app.ps_vision_jog('y', -1)
                                Widget:
                        
                        # Action buttons
                        BoxLayout:
                            orientation: 'horizontal'
                            size_hint_y: None
                            height: 40
                            spacing: 8
                            
                            Button:
                                id: vision_reset_qr_offset_btn
                                text: 'Reset QR Offset'
                                font_size: '13sp'
                                background_color: 0.5, 0.4, 0.3, 1
                                on_press: app.ps_vision_reset_qr_offset()
                            
                            Button:
                                id: vision_set_qr_offset_btn
                                text: 'Set QR Offset'
                                font_size: '13sp'
                                background_color: 0.2, 0.6, 0.3, 1
                                on_press: app.ps_vision_set_qr_offset()
                        
                        # Instruction text anchored to bottom right
                        Label:
                            text: 'Align the crosshair with the center of the ID Code'
                            font_size: '12sp'
                            italic: True
                            color: 0.6, 0.8, 0.9, 1
                            halign: 'right'
                            valign: 'bottom'
                            text_size: self.size
            
            EnableableTabbedPanelItem:
                id: programming_tab
                phase_name: 'Program'
                settings_key: 'programming_enabled'
                phase_enabled: True if app.panel_settings and app.panel_settings.get('programming_enabled', True) else False
                on_state: app.ps_programming_tab_changed(self.state)
                
                BoxLayout:
                    orientation: 'vertical'
                    spacing: 10
                    padding: 20
                    disabled: not programming_tab.phase_enabled
                    opacity: 1.0 if programming_tab.phase_enabled else 0.4
                    
                    # Programmer Type selector
                    BoxLayout:
                        orientation: 'horizontal'
                        size_hint_y: None
                        height: 40
                        spacing: 10
                        
                        Label:
                            text: 'Programmer Type:'
                            size_hint_x: 0.3
                            halign: 'right'
                            valign: 'center'
                            text_size: self.size
                        
                        Spinner:
                            id: ps_programmer_type_spinner
                            text: 'Nordic nRF (nrfutil)'
                            values: []
                            size_hint_x: 0.7
                            on_text: app.ps_on_programmer_type_change(self.text)
                    
                    # Horizontal layout for Steps and Firmware
                    BoxLayout:
                        orientation: 'horizontal'
                        spacing: 20
                        
                        # Left side: Programming Steps
                        BoxLayout:
                            orientation: 'vertical'
                            size_hint_x: 0.4
                            
                            Label:
                                text: 'Programming Steps'
                                size_hint_y: None
                                height: 30
                                font_size: '14sp'
                                bold: True
                                halign: 'left'
                                valign: 'center'
                                text_size: self.size
                            
                            # Container for dynamic step toggles
                            BoxLayout:
                                id: ps_steps_container
                                orientation: 'vertical'
                                spacing: 5
                                size_hint_y: None
                                height: self.minimum_height
                            
                            Widget:
                                # Spacer
                        
                        # Right side: Firmware Files
                        BoxLayout:
                            orientation: 'vertical'
                            size_hint_x: 0.6
                            
                            Label:
                                text: 'Firmware Files'
                                size_hint_y: None
                                height: 30
                                font_size: '14sp'
                                bold: True
                                halign: 'left'
                                valign: 'center'
                                text_size: self.size
                            
                            # Container for dynamic firmware inputs
                            BoxLayout:
                                id: ps_firmware_container
                                orientation: 'vertical'
                                spacing: 5
                                size_hint_y: None
                                height: self.minimum_height
                            
                            Widget:
                                # Spacer

            EnableableTabbedPanelItem:
                id: provision_tab
                phase_name: 'Provision'
                settings_key: 'provision_enabled'
                phase_enabled: True if app.panel_settings and app.panel_settings.get('provision_enabled', False) else False
                
                BoxLayout:
                    orientation: 'vertical'
                    spacing: 10
                    padding: 20
                    disabled: not provision_tab.phase_enabled
                    opacity: 1.0 if provision_tab.phase_enabled else 0.4
                    
                    # Description
                    Label:
                        text: 'Provisioning assigns unique identifiers and configuration\\nto each board during the programming cycle.'
                        size_hint_y: None
                        height: 60
                        font_size: '14sp'
                        color: 0.7, 0.7, 0.7, 1
                        halign: 'center'
                        valign: 'top'
                        text_size: self.size
                    
                    # Placeholder for future provisioning options
                    Label:
                        text: '(Provisioning options will appear here)'
                        size_hint_y: None
                        height: 40
                        font_size: '12sp'
                        color: 0.5, 0.5, 0.5, 1
                        halign: 'center'
                        valign: 'center'
                        text_size: self.size
                    
                    Widget:
                        # Spacer

            EnableableTabbedPanelItem:
                id: test_tab
                phase_name: 'Test'
                settings_key: 'test_enabled'
                phase_enabled: True if app.panel_settings and app.panel_settings.get('test_enabled', False) else False
                
                BoxLayout:
                    orientation: 'vertical'
                    spacing: 10
                    padding: 20
                    disabled: not test_tab.phase_enabled
                    opacity: 1.0 if test_tab.phase_enabled else 0.4
                    
                    # Description
                    Label:
                        text: 'Testing validates board functionality after programming\\nby running automated test sequences.'
                        size_hint_y: None
                        height: 60
                        font_size: '14sp'
                        color: 0.7, 0.7, 0.7, 1
                        halign: 'center'
                        valign: 'top'
                        text_size: self.size
                    
                    # Placeholder for future test options
                    Label:
                        text: '(Test configuration will appear here)'
                        size_hint_y: None
                        height: 40
                        font_size: '12sp'
                        color: 0.5, 0.5, 0.5, 1
                        halign: 'center'
                        valign: 'center'
                        text_size: self.size
                    
                    Widget:
                        # Spacer
