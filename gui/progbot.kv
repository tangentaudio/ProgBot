#:kivy 2.0
#:import NoTransition kivy.uix.screenmanager.NoTransition

# NOTE: All buttons should have visual feedback when pressed
# Use background_normal: '' and background_down: '' with a state-based background_color
# Example: background_color: (darker_color) if self.state == 'down' else (normal_color)

<PanelFileRow@Button>:
    filename: ''
    fullpath: ''
    selected: False
    size_hint_y: None
    height: 60
    text: self.filename
    font_size: '18sp'
    halign: 'left'
    valign: 'center'
    text_size: self.size
    padding: 10, 0
    on_release: app.on_file_row_pressed(self.fullpath)
    background_color: (0.3, 0.5, 0.8, 1) if self.selected else (0.2, 0.2, 0.2, 1)
    background_normal: ''

<GridCell>:
    orientation: 'vertical'
    padding: 5
    spacing: 1
    size_hint: 1, 1
    
    canvas.before:
        Color:
            rgba: root.cell_bg_color[0], root.cell_bg_color[1], root.cell_bg_color[2], root.cell_bg_color[3] * root.pulse_alpha
        Rectangle:
            pos: self.pos
            size: self.size
    
    canvas:
        Color:
            rgba: 0, 0, 0, 0.75
        Rectangle:
            pos: self.x + 4, self.y + 4
            size: self.width - 8, self.height - 8
    
    canvas.after:
        Color:
            rgba: 0, 0, 0, 1
        Line:
            rectangle: (self.x, self.y, self.width, self.height)
            width: 1
    
    # Top row: Board number (left) + result icon (right)
    BoxLayout:
        orientation: 'horizontal'
        size_hint_y: 0.4
        padding: 2, 0
        
        Label:
            text: root.cell_label
            bold: True
            color: root.cell_label_color
            font_size: '22sp'
            size_hint_x: 0.65
            halign: 'left'
            valign: 'top'
            text_size: self.size
            padding: 3, 0
        
        Label:
            text: root.result_icon
            bold: True
            color: root.result_icon_color
            font_size: '26sp'
            font_name: '/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf'
            size_hint_x: 0.35
            halign: 'right'
            valign: 'top'
            text_size: self.size
            padding: 0, 0, 5, 0
            opacity: 1.0 if root.result_icon else 0.0
    
    # Middle row: Serial number (left) + status dots with labels (right)
    BoxLayout:
        orientation: 'horizontal'
        size_hint_y: 0.38
        padding: 2, 0
        opacity: 0.3 if not root.cell_checked else (0.0 if root.failure_reason else 1.0)
        
        Label:
            text: root.serial_number if root.serial_number else ''
            bold: True
            color: [1, 1, 0.7, 1]
            font_size: '11sp'
            size_hint_x: 0.35
            halign: 'left'
            valign: 'middle'
            text_size: self.size
            padding: 3, 0
        
        # Status dots container - right aligned with labels
        BoxLayout:
            orientation: 'horizontal'
            size_hint_x: 0.65
            spacing: 0
            padding: 0, 0, 2, 0
            
            Widget:
                # Spacer to push dots right
                size_hint_x: 0.02
            
            # Vision
            BoxLayout:
                orientation: 'vertical'
                size_hint_x: None
                width: 22
                Label:
                    text: root.vision_dot
                    font_size: '18sp'
                    font_name: '/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf'
                    size_hint_y: 0.65
                    halign: 'center'
                    valign: 'bottom'
                    color: 1, 1, 1, 1 if root.vision_enabled else 0.3
                Label:
                    text: 'V'
                    font_size: '7sp'
                    size_hint_y: 0.35
                    halign: 'center'
                    valign: 'top'
                    color: 0.5, 0.5, 0.5, 1 if root.vision_enabled else 0.2
            
            # Contact (probe)
            BoxLayout:
                orientation: 'vertical'
                size_hint_x: None
                width: 22
                Label:
                    text: root.contact_dot
                    font_size: '18sp'
                    font_name: '/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf'
                    size_hint_y: 0.65
                    halign: 'center'
                    valign: 'bottom'
                    color: 1, 1, 1, 1 if root.contact_enabled else 0.3
                Label:
                    text: 'C'
                    font_size: '7sp'
                    size_hint_y: 0.35
                    halign: 'center'
                    valign: 'top'
                    color: 0.5, 0.5, 0.5, 1 if root.contact_enabled else 0.2
            
            # Program
            BoxLayout:
                orientation: 'vertical'
                size_hint_x: None
                width: 22
                Label:
                    text: root.program_dot
                    font_size: '18sp'
                    font_name: '/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf'
                    size_hint_y: 0.65
                    halign: 'center'
                    valign: 'bottom'
                    color: 1, 1, 1, 1 if root.program_enabled else 0.3
                Label:
                    text: 'P'
                    font_size: '7sp'
                    size_hint_y: 0.35
                    halign: 'center'
                    valign: 'top'
                    color: 0.5, 0.5, 0.5, 1 if root.program_enabled else 0.2
            
            # Provision
            BoxLayout:
                orientation: 'vertical'
                size_hint_x: None
                width: 22
                Label:
                    text: root.provision_dot
                    font_size: '18sp'
                    font_name: '/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf'
                    size_hint_y: 0.65
                    halign: 'center'
                    valign: 'bottom'
                    color: 1, 1, 1, 1 if root.provision_enabled else 0.3
                Label:
                    text: 'S'
                    font_size: '7sp'
                    size_hint_y: 0.35
                    halign: 'center'
                    valign: 'top'
                    color: 0.5, 0.5, 0.5, 1 if root.provision_enabled else 0.2
            
            # Test
            BoxLayout:
                orientation: 'vertical'
                size_hint_x: None
                width: 22
                Label:
                    text: root.test_dot
                    font_size: '18sp'
                    font_name: '/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf'
                    size_hint_y: 0.65
                    halign: 'center'
                    valign: 'bottom'
                    color: 1, 1, 1, 1 if root.test_enabled else 0.3
                Label:
                    text: 'T'
                    font_size: '7sp'
                    size_hint_y: 0.35
                    halign: 'center'
                    valign: 'top'
                    color: 0.5, 0.5, 0.5, 1 if root.test_enabled else 0.2
    
    # Bottom row: Failure reason (only shown when failed)
    Label:
        text: root.failure_reason
        size_hint_y: 0.22
        font_size: '11sp'
        bold: True
        color: [1, 0.7, 0.7, 1]
        halign: 'left'
        valign: 'top'
        text_size: self.width - 6, self.height
        padding: 3, 0
        shorten: True
        shorten_from: 'right'
        opacity: 1.0 if root.failure_reason else 0.0

<LogViewer>:
    effect_cls: 'ScrollEffect'
    scroll_type: ['bars']
    bar_width: 15
    do_scroll: (self.width, True)
    
    TextInput:
        id: log_text
        readonly: True
        foreground_color: 1, 1, 1, 1
        background_color: 0, 0, 0, 1
        size_hint_y: None
        cursor_blink: False
        multiline: True
        height: self.minimum_height
        allow_copy: False
        allow_paste: False
        selection_color: 0, 0, 0, 0
        disabled_foreground_color: 1, 1, 1, 1
        disabled: True

<LogPopup@Popup>:
    id: log_popup
    title: 'Log Viewer'
    size_hint: 0.8, 0.8
    
    BoxLayout:
        orientation: 'vertical'
        
        # Filter buttons
        BoxLayout:
            size_hint_y: None
            height: '40dp'
            spacing: 5
            padding: 5
            
            Label:
                text: 'Filter:'
                size_hint_x: None
                width: '50dp'
            
            ToggleButton:
                text: 'DEBUG'
                group: 'log_filter'
                size_hint_x: 0.25
                on_state: if self.state == 'down': log_viewer_widget.set_filter_level('DEBUG')
            
            ToggleButton:
                text: 'INFO'
                group: 'log_filter'
                state: 'down'
                size_hint_x: 0.25
                on_state: if self.state == 'down': log_viewer_widget.set_filter_level('INFO')
            
            ToggleButton:
                text: 'WARNING'
                group: 'log_filter'
                size_hint_x: 0.25
                on_state: if self.state == 'down': log_viewer_widget.set_filter_level('WARNING')
            
            ToggleButton:
                text: 'ERROR'
                group: 'log_filter'
                size_hint_x: 0.25
                on_state: if self.state == 'down': log_viewer_widget.set_filter_level('ERROR')
        
        LogViewer:
            id: log_viewer_widget
            size_hint_y: 0.85
        
        Button:
            text: 'Close'
            size_hint_y: None
            height: '40dp'
            background_normal: ''
            background_down: ''
            background_color: (0.35, 0.35, 0.4, 1) if self.state == 'down' else (0.25, 0.25, 0.3, 1)
            on_press: root.dismiss()

<StatsPopup@Popup>:
    id: stats_popup
    title: 'Cycle Statistics'
    size_hint: 0.6, 0.6
    
    BoxLayout:
        orientation: 'vertical'
        padding: 10
        spacing: 10
        
        Label:
            id: stats_label
            text: 'Ready'
            size_hint_y: 0.85
            font_size: '14sp'
            halign: 'left'
            valign: 'top'
            text_size: self.size
            padding: 8, 8
        
        Button:
            text: 'Close'
            size_hint_y: 0.15
            background_normal: ''
            background_down: ''
            background_color: (0.35, 0.35, 0.4, 1) if self.state == 'down' else (0.25, 0.25, 0.3, 1)
            on_press: root.dismiss()

# PanelSetupPopup has been moved to panel_setup.kv and is loaded by PanelSetupController

<IdleScreen@Screen>:
    name: 'idle'
    
    BoxLayout:
        orientation: 'vertical'
        
        Label:
            text: 'Camera Preview Area'
            font_size: '12sp'
            color: 0.4, 0.4, 0.4, 1
            halign: 'center'
            valign: 'middle'
            text_size: self.size

<CameraScreen@Screen>:
    name: 'camera'
    
    BoxLayout:
        orientation: 'vertical'
        padding: 0
        
        Label:
            id: camera_status_label
            text: 'QR Scanning...'
            size_hint_y: None
            height: 24
            font_size: '11sp'
            bold: True
            color: 0.9, 0.9, 0.5, 1
            halign: 'center'
            valign: 'center'
            text_size: self.width, None
            shorten: True
            shorten_from: 'right'
        
        # Center container for the image with border
        AnchorLayout:
            anchor_x: 'center'
            anchor_y: 'center'
            
            BoxLayout:
                size_hint: None, None
                size: 141, 141  # Square container for camera preview
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 1
                    Line:
                        rectangle: self.x, self.y, self.width, self.height
                        width: 2
                
                Image:
                    id: camera_preview_image
                    allow_stretch: True
                    keep_ratio: True

<ErrorPopup@Popup>:
    id: error_popup
    title: 'Error'
    size_hint: 0.85, 0.85
    auto_dismiss: False

    BoxLayout:
        orientation: 'vertical'
        spacing: 6
        padding: 8

        Label:
            id: error_message
            text: 'An error occurred'
            size_hint_y: None
            height: 40
            halign: 'left'
            valign: 'middle'
            text_size: self.size

        ScrollView:
            size_hint_y: 1
            do_scroll_x: False

            TextInput:
                id: error_trace
                readonly: True
                foreground_color: 1, 1, 1, 1
                background_color: 0, 0, 0, 1
                size_hint_y: None
                height: max(self.minimum_height, 300)
                cursor_blink: False
                multiline: True
                allow_copy: True
                allow_paste: False
                selection_color: 0.2, 0.4, 1, 0.3
                disabled_foreground_color: 1, 1, 1, 1
                disabled: True

        BoxLayout:
            size_hint_y: None
            height: 50
            spacing: 8

            Button:
                text: 'Abort Cycle'
                background_normal: ''
                background_down: ''
                background_color: (0.9, 0.2, 0.2, 1) if self.state == 'down' else (0.8, 0.1, 0.1, 1)
                on_press: app.on_error_abort()

            Button:
                text: 'Retry This Board'
                background_normal: ''
                background_down: ''
                background_color: (0.2, 0.7, 0.9, 1) if self.state == 'down' else (0.1, 0.6, 0.8, 1)
                on_press: app.on_error_retry()

            Button:
                text: 'Skip This Board'
                background_normal: ''
                background_down: ''
                background_color: (0.7, 0.7, 0.2, 1) if self.state == 'down' else (0.6, 0.6, 0.1, 1)
                on_press: app.on_error_skip()

<PanelFileChooser@Popup>:
    id: panel_chooser
    title: 'Select Panel Settings File'
    size_hint: 0.95, 0.9
    
    BoxLayout:
        orientation: 'vertical'
        spacing: 12
        padding: 15

        Label:
            text: 'Choose a .panel file:'
            size_hint_y: None
            height: 50
            font_size: '16sp'
            halign: 'left'
            valign: 'center'
            text_size: self.size

        RecycleView:
            id: file_list
            size_hint_y: 1
            viewclass: 'PanelFileRow'
            do_scroll_x: False
            scroll_type: ['bars', 'content']
            bar_width: 10
            RecycleBoxLayout:
                id: file_layout
                default_size: None, 60
                default_size_hint: 1, None
                size_hint_y: None
                height: self.minimum_height
                orientation: 'vertical'
                spacing: 4
                key_selection: 'selectable'

        BoxLayout:
            size_hint_y: None
            height: 70
            spacing: 12
            padding: 8

            Button:
                text: 'Load'
                font_size: '16sp'
                background_normal: ''
                background_down: ''
                background_color: (0.1, 0.9, 0.3, 1) if self.state == 'down' else (0, 0.8, 0.2, 1)
                on_press: app.on_custom_panel_file_selected()
                on_press: root.dismiss()

            Button:
                text: 'Cancel'
                font_size: '16sp'
                background_normal: ''
                background_down: ''
                background_color: (0.35, 0.35, 0.4, 1) if self.state == 'down' else (0.25, 0.25, 0.3, 1)
                on_press: root.dismiss()

<SavePanelDialog@Popup>:
    id: save_panel_dialog
    title: 'Save Panel As'
    size_hint: 0.85, 0.5
    
    BoxLayout:
        orientation: 'vertical'
        spacing: 15
        padding: 15

        Label:
            text: 'Panel file name (.panel will be added):'
            size_hint_y: None
            height: 50
            halign: 'left'
            valign: 'center'
            text_size: self.size
            font_size: '14sp'

        TextInput:
            id: panel_name_input
            multiline: False
            size_hint_y: None
            height: 80
            font_size: '16sp'
            write_tab: False

        BoxLayout:
            size_hint_y: None
            height: 60
            spacing: 12

            Button:
                text: 'Save'
                font_size: '14sp'
                background_normal: ''
                background_down: ''
                background_color: (0.1, 0.9, 0.3, 1) if self.state == 'down' else (0, 0.8, 0.2, 1)
                on_press: app.on_save_panel_confirmed(panel_name_input.text)
                on_press: root.dismiss()

            Button:
                text: 'Cancel'
                font_size: '14sp'
                background_normal: ''
                background_down: ''
                background_color: (0.35, 0.35, 0.4, 1) if self.state == 'down' else (0.25, 0.25, 0.3, 1)
                on_press: root.dismiss()

<AppRoot@BoxLayout>:
    orientation: 'vertical'

    BoxLayout:
        orientation: 'horizontal'

        BoxLayout:
            orientation: 'vertical'

            GridLayout:
                canvas.before:
                    Color:
                        rgba: 0.1, 0.1, 0.2, 1
                    Rectangle:
                        pos: self.pos
                        size: self.size
                
                canvas.after:
                    Color:
                        rgba: 0, 0, 0, 1
                    # Border around entire grid
                    Line:
                        rectangle: (self.x, self.y, self.width, self.height)
                        width: 2
                
                id: panel_grid
                size_hint_y: 0.9
                multitouch_sim_timeout: 0

        BoxLayout:
            id: info_panel
            orientation: 'vertical'
            size_hint_x: 0.5
            spacing: 4
            padding: 4, 4, 4, 4

            canvas.before:
                Color:
                    rgba: 0.2, 0.2, 0.2, 1
                Rectangle:
                    pos: self.pos
                    size: self.size

            # Top bar with panel name and hamburger menu
            BoxLayout:
                orientation: 'horizontal'
                size_hint_y: None
                height: 40
                spacing: 4
                
                Label:
                    id: panel_file_label
                    text: "default.panel"
                    font_size: '16sp'
                    halign: 'left'
                    valign: 'center'
                    text_size: self.size
                    color: 0.8, 0.8, 0.8, 1
                
                Button:
                    id: menu_btn
                    text: 'â˜°'
                    size_hint_x: None
                    width: 70
                    font_size: '24sp'
                    font_name: 'DejaVuSans'
                    background_normal: ''
                    background_down: ''
                    background_color: (0.2, 0.25, 0.3, 0.5) if self.state == 'down' else (0, 0, 0, 0)
                    on_release: app.show_main_menu()
            
            # Main controls (formerly Run tab content)
            BoxLayout:
                orientation: 'horizontal'
                size_hint_y: None
                height: 80
                spacing: 4

                Button:
                    id: home_btn
                    text: 'HOME'
                    size_hint_x: 0.25
                    size_hint_y: None
                    height: 70
                    font_size: '12sp'
                    bold: True
                    background_normal: ''
                    background_down: ''
                    background_color: 0, 0, 0, 0
                    canvas.before:
                        Color:
                            rgba: (0.35, 0.35, 0.4, 1) if self.state == 'down' else (0.45, 0.45, 0.5, 1)
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [10]
                    on_press: app.home_machine(self)

                Button:
                    id: stop_btn
                    text: 'STOP'
                    disabled: True
                    size_hint_x: 0.375
                    size_hint_y: None
                    height: 70
                    font_size: '12sp'
                    bold: True
                    background_normal: ''
                    background_down: ''
                    background_color: 0, 0, 0, 0
                    canvas.before:
                        Color:
                            rgba: (0.3, 0.3, 0.35, 1) if self.disabled else ((0.4, 0.2, 0.2, 1) if self.state == 'down' else (0.5, 0.3, 0.3, 1))
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [10]
                    on_press: app.stop(self)

                Button:
                    id: start_btn
                    text: 'START'
                    size_hint_x: 0.375
                    size_hint_y: None
                    height: 70
                    font_size: '12sp'
                    bold: True
                    background_normal: ''
                    background_down: ''
                    background_color: 0, 0, 0, 0
                    canvas.before:
                        Color:
                            rgba: (0.2, 0.4, 0.2, 1) if self.state == 'down' else (0.3, 0.5, 0.3, 1)
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [10]
                    on_press: app.start(self)
            
            BoxLayout:
                orientation: 'horizontal'
                size_hint_y: None
                height: 50
                spacing: 8
                padding: [0, 8, 0, 0]
                
                Button:
                    id: reset_grid_btn
                    text: 'Reset Grid'
                    font_size: '12sp'
                    background_normal: ''
                    background_down: ''
                    background_color: 0, 0, 0, 0
                    canvas.before:
                        Color:
                            rgba: (0.35, 0.35, 0.4, 1) if self.state == 'down' else (0.45, 0.45, 0.5, 1)
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [10]
                    on_press: app.reset_grid(self)
                
                Button:
                    id: skip_all_btn
                    text: 'Skip All'
                    font_size: '12sp'
                    background_normal: ''
                    background_down: ''
                    background_color: 0, 0, 0, 0
                    canvas.before:
                        Color:
                            rgba: (0.35, 0.35, 0.4, 1) if self.state == 'down' else (0.45, 0.45, 0.5, 1)
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [10]
                    on_press: app.skip_all_boards(self)
                
                Button:
                    id: enable_all_btn
                    text: 'Enable All'
                    font_size: '12sp'
                    background_normal: ''
                    background_down: ''
                    background_color: 0, 0, 0, 0
                    canvas.before:
                        Color:
                            rgba: (0.35, 0.35, 0.4, 1) if self.state == 'down' else (0.45, 0.45, 0.5, 1)
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [10]
                    on_press: app.enable_all_boards(self)
            
            Widget:
                size_hint_y: 1
            
            # Camera preview pane (shows during QR scanning)
            ScreenManager:
                id: stats_camera_manager
                size_hint_y: None
                height: 165
                transition: NoTransition()
                
                IdleScreen:
                    id: idle_screen
                
                CameraScreen:
                    id: camera_screen
            
            Widget:
                size_hint_y: 1

            # Status bar at bottom
            BoxLayout:
                orientation: 'horizontal'
                size_hint_y: None
                height: 40
                padding: 4
                spacing: 4

                canvas.before:
                    Color:
                        rgba: 0, 0.2, .8, 1
                    Rectangle:
                        pos: self.pos
                        size: self.size

                Label:
                    id: phase_label
                    text: "Idle"
                    size_hint_x: 0.8
                    size_hint_y: None
                    height: 40
                    font_size: '16sp'
                    bold: True
                    halign: 'left'
                    valign: 'center'
                    text_size: self.size
                    color: 1, 1, 1, 1

                Label:
                    id: cycle_timer_label
                    text: ""
                    size_hint_x: 0.2
                    size_hint_y: None
                    height: 40
                    font_size: '16sp'
                    bold: True
                    halign: 'right'
                    valign: 'center'
                    text_size: self.size
                    color: 1, 1, 0.5, 1

# ==================== Widget Definitions ====================

<MainMenuDropDown@DropDown>:
    auto_width: False
    width: 180
    
    BoxLayout:
        orientation: 'vertical'
        size_hint_y: None
        height: self.minimum_height
        spacing: 1
        padding: 2
        
        canvas.before:
            Color:
                rgba: 0.2, 0.2, 0.25, 1
            Rectangle:
                pos: self.pos
                size: self.size
            Color:
                rgba: 0.4, 0.4, 0.45, 1
            Line:
                rectangle: self.x, self.y, self.width, self.height
                width: 1
        
        Button:
            text: 'Load Panel'
            size_hint_y: None
            height: 44
            font_size: '16sp'
            background_normal: ''
            background_down: ''
            background_color: (0.35, 0.35, 0.4, 1) if self.state == 'down' else (0.25, 0.25, 0.3, 1)
            color: 0.9, 0.9, 0.9, 1
            on_release: app.menu_load_panel()
        
        Button:
            text: 'Panel Setup'
            size_hint_y: None
            height: 44
            font_size: '16sp'
            background_normal: ''
            background_down: ''
            background_color: (0.35, 0.35, 0.4, 1) if self.state == 'down' else (0.25, 0.25, 0.3, 1)
            color: 0.9, 0.9, 0.9, 1
            on_release: app.menu_panel_setup()
        
        Button:
            text: 'Config Settings'
            size_hint_y: None
            height: 44
            font_size: '16sp'
            background_normal: ''
            background_down: ''
            background_color: (0.35, 0.35, 0.4, 1) if self.state == 'down' else (0.25, 0.25, 0.3, 1)
            color: 0.9, 0.9, 0.9, 1
            on_release: app.menu_config_settings()
        
        Button:
            text: 'Log Viewer'
            size_hint_y: None
            height: 44
            font_size: '16sp'
            background_normal: ''
            background_down: ''
            background_color: (0.35, 0.35, 0.4, 1) if self.state == 'down' else (0.25, 0.25, 0.3, 1)
            color: 0.9, 0.9, 0.9, 1
            on_release: app.menu_log_viewer()
        
        Button:
            text: 'Stats'
            size_hint_y: None
            height: 44
            font_size: '16sp'
            background_normal: ''
            background_down: ''
            background_color: (0.35, 0.35, 0.4, 1) if self.state == 'down' else (0.25, 0.25, 0.3, 1)
            color: 0.9, 0.9, 0.9, 1
            on_release: app.menu_stats()
        
        Widget:
            size_hint_y: None
            height: 8
        
        Button:
            text: 'Exit'
            size_hint_y: None
            height: 44
            font_size: '16sp'
            background_normal: ''
            background_down: ''
            background_color: (0.5, 0.3, 0.3, 1) if self.state == 'down' else (0.4, 0.25, 0.25, 1)
            color: 0.9, 0.9, 0.9, 1
            on_release: app.menu_exit()

<SerialPortRow@Button>:
    port_device: ''
    port_description: ''
    port_unique_id: ''
    port_index: 0
    selected: False
    size_hint_y: None
    height: 80
    halign: 'left'
    valign: 'center'
    padding: 15, 5
    on_release: app.on_serial_port_row_pressed(self.port_index)
    background_color: (0.3, 0.5, 0.8, 1) if self.selected else (0.2, 0.2, 0.2, 1)
    background_normal: ''
    
    BoxLayout:
        orientation: 'vertical'
        spacing: 2
        pos: root.pos
        size: root.size
        padding: 15, 10
        
        Label:
            text: root.port_device
            font_size: '18sp'
            bold: True
            size_hint_y: 0.4
            halign: 'left'
            valign: 'center'
            text_size: self.size
            color: 1, 1, 1, 1
        
        Label:
            text: root.port_description
            font_size: '14sp'
            size_hint_y: 0.3
            halign: 'left'
            valign: 'center'
            text_size: self.size
            color: 0.8, 0.8, 0.8, 1
        
        Label:
            text: root.port_unique_id
            font_size: '12sp'
            size_hint_y: 0.3
            halign: 'left'
            valign: 'center'
            text_size: self.size
            color: 0.6, 0.6, 0.6, 1

<SerialPortChooser@Popup>:
    id: serial_port_chooser
    title: 'Select Serial Port'
    size_hint: 0.95, 0.9
    
    BoxLayout:
        orientation: 'vertical'
        spacing: 12
        padding: 15

        Label:
            id: device_type_label
            text: 'Select port for device:'
            size_hint_y: None
            height: 50
            font_size: '18sp'
            bold: True
            halign: 'left'
            valign: 'center'
            text_size: self.size

        RecycleView:
            id: port_list
            size_hint_y: 1
            viewclass: 'SerialPortRow'
            do_scroll_x: False
            scroll_type: ['bars', 'content']
            bar_width: 15
            RecycleBoxLayout:
                id: port_layout
                default_size: None, 80
                default_size_hint: 1, None
                size_hint_y: None
                height: self.minimum_height
                orientation: 'vertical'
                spacing: 8
                key_selection: 'selectable'

        BoxLayout:
            size_hint_y: None
            height: 70
            spacing: 12
            padding: 8

            Button:
                text: 'Select'
                font_size: '18sp'
                on_press: app.on_serial_port_selected()
                on_press: root.dismiss()

